YUI.add("moodle-mod_aiquiz-dragdrop",function(g,e){var i,u=".actions",o="activity",p="mod-quiz-edit-content",r="editing_move",s="iconsmall",c="jumpmenu",n="left",h="movedown",_="moveup",m="page-content",d="right",f="slots",a="section-handle",v="slots",l="sectiondraggable",z="li.page",q="li.slot",t=function(){t.superclass.constructor.apply(this,arguments)};g.extend(t,M.core.dragdrop,{sectionlistselector:null,initializer:function(){if(this.groups=[l],this.samenodeclass="section",this.parentnodeclass="slots",g.Node.one("."+c))return!1;var e;this.sectionlistselector="li.section",this.sectionlistselector&&(this.sectionlistselector="."+p+" "+this.sectionlistselector,this.setup_for_section(this.sectionlistselector),(e=new g.DD.Delegate({container:"."+p,nodes:"."+l,target:!0,handles:["."+n],dragConfig:{groups:this.groups}})).dd.plug(g.Plugin.DDProxy,{moveOnEnd:!1}),e.dd.plug(g.Plugin.DDConstrained,{constrain:"#"+m,stickY:!0}),e.dd.plug(g.Plugin.DDWinScroll))},setup_for_section:function(e){g.Node.all(e).each(function(e){var i,o,t,s=g.Moodle.core_course.util.section.getId(e);0<s&&(i=e.one("."+d+" a."+h),o=e.one("."+d+" a."+_),s=M.util.get_string("movesection","moodle",s),t=e.one("."+n),(i||o)&&t&&(t.setStyle("cursor","move"),t.appendChild(this.get_drag_handle(s,a,"icon",!0)),o&&o.remove(),i&&i.remove(),e.addClass(l)))},this)},drag_start:function(e){var e=e.target,i=g.Node.create('<ul class="slots"></ul>'),o=g.Node.create('<ul class="section"></ul>');o.setStyle("margin",0),o.setContent(e.get("node").get("innerHTML")),i.appendChild(o),e.get("dragNode").setContent(i),e.get("dragNode").addClass(p)},drag_dropmiss:function(e){this.drop_hit(e)},get_section_index:function(e){var i="."+p+" li.section",i=g.all(i);return i.indexOf(e)-i.indexOf(g.one("#section-0"))},drop_hit:function(d){var r,a,e,n,i,o=d.drag,c=o.get("node"),t=g.Moodle.core_course.util.section.getId(c),l=t,s=this.get_section_index(c),u=s;if(t!==s){for(i in u<l&&(l=s,u=t),o.get("dragNode").removeClass(p),r=g.Node.all(this.sectionlistselector),a=M.util.add_lightbox(g,c),e={},n=this.get("config").pageparams)n.hasOwnProperty(i)&&(e[i]=n[i]);e.sesskey=M.cfg.sesskey,e.courseid=this.get("courseid"),e.quizid=this.get("quizid"),e["class"]="section",e.field="move",e.id=t,e.value=s,o=M.cfg.wwwroot+this.get("ajaxurl"),g.io(o,{method:"POST",data:e,on:{start:function(){a.show()},success:function(e,i){var o,t,s,n;try{(o=g.JSON.parse(i.responseText)).error&&new M.core.ajaxException(o),M.mod_aiquiz.edit.process_sections(g,r,o,l,u)}catch(d){}s=!1;do{for(s=!1,t=l;t<=u;t++)g.Moodle.core_course.util.section.getId(r.item(t-1))>g.Moodle.core_course.util.section.getId(r.item(t))&&(n=r.item(t-1).get("id"),r.item(t-1).set("id",r.item(t).get("id")),r.item(t).set("id",n),M.mod_aiquiz.edit.swap_sections(g,t-1,t),s=!0)}while(u-=1,s);window.setTimeout(function(){a.hide()},250)},failure:function(e,i){this.ajax_failure(i),a.hide()}},context:this})}}},{NAME:"mod_aiquiz-dragdrop-section",ATTRS:{courseid:{value:null},quizid:{value:null},ajaxurl:{value:0},config:{value:0}}}),M.mod_aiquiz=M.mod_aiquiz||{},M.mod_aiquiz.init_section_dragdrop=function(e){new t(e)},g.extend(i=function(){i.superclass.constructor.apply(this,arguments)},M.core.dragdrop,{initializer:function(){var e;this.groups=["resource"],this.samenodeclass=o,this.parentnodeclass=f,this.samenodelabel={identifier:"dragtoafter",component:"quiz"},this.parentnodelabel={identifier:"dragtostart",component:"quiz"},this.setup_for_section(),e="li."+o,(e=new g.DD.Delegate({container:"."+p,nodes:e,target:!0,handles:["."+r],dragConfig:{groups:this.groups}})).dd.plug(g.Plugin.DDProxy,{moveOnEnd:!1,cloneNode:!0}),e.dd.plug(g.Plugin.DDConstrained,{constrain:"#"+v}),e.dd.plug(g.Plugin.DDWinScroll),M.mod_aiquiz.quizbase.register_module(this),M.mod_aiquiz.dragres=this},setup_for_section:function(){g.Node.all(".mod-quiz-edit-content ul.slots ul.section").each(function(e){e.setAttribute("data-draggroups",this.groups.join(" ")),new g.DD.Drop({node:e,groups:this.groups,padding:"20 0 20 0"}),this.setup_for_resource("li.activity")},this)},setup_for_resource:function(e){g.Node.all(e).each(function(e){var i,e=e.one("a."+r);e&&(i=this.get_drag_handle(M.util.get_string("move","moodle"),r,s,!0),e.replace(i))},this)},drag_start:function(e){e=e.target;e.get("dragNode").setContent(e.get("node").get("innerHTML")),e.get("dragNode").all(".icon").setStyle("vertical-align","baseline")},drag_dropmiss:function(e){this.drop_hit(e)},drop_hit:function(e){var i,o=e.drag,t=o.get("node"),e=t.one(u),s=M.util.add_spinner(g,e),n={},d=this.get("config").pageparams;for(i in d)n[i]=d[i];n.sesskey=M.cfg.sesskey,n.courseid=this.get("courseid"),n.quizid=this.get("quizid"),n["class"]="resource",n.field="move",n.id=Number(g.Moodle.mod_aiquiz.util.slot.getId(t)),n.sectionId=g.Moodle.core_course.util.section.getId(t.ancestor("li.section",!0)),(e=t.previous(q))&&(n.previousid=Number(g.Moodle.mod_aiquiz.util.slot.getId(e))),(e=t.previous(z))&&(n.page=Number(g.Moodle.mod_aiquiz.util.page.getId(e))),e=M.cfg.wwwroot+this.get("ajaxurl"),g.io(e,{method:"POST",data:n,on:{start:function(){this.lock_drag_handle(o,r),s.show()},success:function(e,i){i=g.JSON.parse(i.responseText),i={element:t,visible:i.visible};M.mod_aiquiz.quizbase.invoke_function("set_visibility_resource_ui",i),this.unlock_drag_handle(o,r),window.setTimeout(function(){s.hide()},250),M.mod_aiquiz.resource_toolbox.reorganise_edit_page()},failure:function(e,i){this.ajax_failure(i),this.unlock_drag_handle(o,a),s.hide(),window.location.reload(!0)}},context:this})},global_drop_over:function(e){var i,o,t;e.drop&&e.drop.inGroup(this.groups)&&(i=e.drag.get("node"),o=e.drop.get("node"),this.lastdroptarget=e.drop,o.hasClass(this.samenodeclass)?(t=this.goingup?"before":"after",o.insert(i,t)):!o.hasClass(this.parentnodeclass)&&!o.test('[data-droptarget="1"]')||o.contains(i)||(this.goingup?o.append(i):o.prepend(i)),this.drop_over(e))}},{NAME:"mod_aiquiz-dragdrop-resource",ATTRS:{courseid:{value:null},quizid:{value:null},ajaxurl:{
value:0},config:{value:0}}}),M.mod_aiquiz=M.mod_aiquiz||{},M.mod_aiquiz.init_resource_dragdrop=function(e){new i(e)}},"@VERSION@",{requires:["base","node","io","dom","dd","dd-scroll","moodle-core-dragdrop","moodle-core-notification","moodle-mod_aiquiz-quizbase","moodle-mod_aiquiz-util-base","moodle-mod_aiquiz-util-page","moodle-mod_aiquiz-util-slot","moodle-course-util"]});